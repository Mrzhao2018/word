# 矮人行为优化说明

## 问题分析

原有系统存在以下问题：
1. **盲目选择目标**：随机选择地图上任意位置，可能选到不可达的海洋或孤岛
2. **频繁空闲切换**：任务失败后长时间冷却，导致矮人长时间静止不动
3. **缺乏持续性**：完成任务后立即空闲，不会继续在附近工作
4. **无闲逛行为**：空闲时完全静止，显得不自然

## 优化方案

### 1. 智能目标选择系统

**实现原理**：
- 收集矮人附近20格内的所有可行走资源点
- 根据地形类型、资源丰富度、距离计算综合评分
- 优先级：树木(3.0) > 石头(2.5) > 山脉(2.0) > 草地(1.5) > 水域(0.5)
- 从评分最高的前30%中随机选择，保持行为多样性

**代码逻辑**：
```rust
// 综合评分公式
score = 地形分数 × 资源丰富度 / (距离 + 1)
```

### 2. 路径预验证机制

**问题**：之前会分配无法到达的目标，导致矮人尝试失败后频繁空闲

**解决方案**：
- 在分配任务前，使用A*算法验证路径是否存在
- 最多尝试5次，找到可达目标才分配任务
- 找不到可达目标时延长冷却时间（3秒），避免频繁尝试

**效果**：
- 大幅减少无效移动
- 避免"接任务→走一步→发现到不了→空闲"的循环

### 3. 快速任务切换

**优化点**：
- 任务完成后冷却时间：2秒 → 0.5秒
- 寻路失败后冷却时间：5秒 → 0.5秒  
- 任务超时时间：30秒 → 20秒
- 任务超时冷却：3秒 → 1秒

**效果**：
- 矮人更快找到新工作
- 减少长时间空闲状态
- 提高工作效率

### 4. 闲逛行为（备用方案）

当找不到任何工作目标时：
- 在当前位置附近3格内随机选择目标
- 缓慢移动，模拟"闲逛"行为
- 保持矮人活跃，避免完全静止

### 5. 调试信息增强

添加实体行为调试宏：
```rust
debug_entity!("矮人找到工作目标: {:?} at {:?}", terrain_type, target);
debug_entity!("矮人任务超时，放弃目标 {:?}", target_pos);
debug_entity!("矮人无法到达目标 {:?}，寻找新目标", target_pos);
```

启用方法：在 `src/debug_config.rs` 中设置
```rust
pub const DEBUG_ENABLED: bool = true;
pub const DEBUG_ENTITY_SPAWN: bool = true;
```

## 性能优化

### 候选搜索范围限制
- 只搜索20格内的目标，避免全地图扫描
- 大地图：搜索400格 vs 全地图可能上万格
- 性能提升：数十倍

### 路径缓存机制（保持）
- 计算一次路径后缓存使用
- 每5秒或到达路径点才重新计算
- 减少寻路算法调用次数

### 评分排序优化
- 只对附近目标排序，数量可控
- 从前30%中随机选择，无需精确最优解

## 预期效果

1. **减少空闲时间**：矮人能更快找到工作并持续工作
2. **提高工作效率**：选择最优资源点，减少移动距离
3. **行为更自然**：连续工作+快速切换，而非频繁空闲
4. **适应地形**：在岛屿/分散地形也能找到附近可达的工作

## 适用场景

特别适合游戏截图中的地形：
- 大量海洋，陆地分散
- 资源点不连续
- 需要矮人在小范围内高效工作

## 后续改进方向

1. **工作记忆**：记录已完成的资源点，避免重复访问枯竭区域
2. **群体协调**：多个矮人避免同时前往同一资源点
3. **优先级系统**：根据仓库库存动态调整资源采集优先级
4. **技能系统**：不同矮人擅长不同工作类型
